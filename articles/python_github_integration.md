# Integration with GitHub

Building [PythonHackers.com](http://pythonhackers.com) series next post is about integration with Github for registration/login purposes. In the first part, we have setup the most basic things for our development. It's now time to start integrations. [PythonHackers Github Repository](https://github.com/pythonhackers/pythonhackers) contains all the code that is described here ands served at [stg.pythonhackers.com](http://stg.pythonhackers.com)

Let's start with basic settings. Go to [GitHub Application Section](https://github.com/settings/applications/new) to create a new application. This will require to write down;

- Application Name
- HomePage URL
- Authorization Callback URL -> <code>dev.yourapplication.com</code>

Authorization Callback URL is the most important bit of this application entry. Because this will be the URL that GitHub will be directing users
to your application. For the develoment purposes you can modify your <code>/etc/hosts</code> files to enter a proper URL

After saving the application, Github will give you the <code>client_id</code> and <code>client_secret</code>. You will need them soon, so save them to your machine

```bash
sudo vim /etc/hosts
```

and add this entry to the hosts file <code>127.0.0.1 dev.yourapplication.com</code>. One thing to be careful with is that if your application uses port in your local
environment, you have to specify the port on the Github settings as well. If the URL does not match, Github will complain that the URL is not matching.


## RAuth

Seems like the most updated python oauth project is [rauth](https://github.com/litl/rauth), claiming that the most updated and comprehensive oauth solution currently. In order to integration with the Github OAuth2 we will use the [rauth](https://github.com/litl/rauth) library.

```bash
pip install rauth
```

## Configuration

Let's do the things in proper way and create a configuration file. Here is mine.


```cfg
[app]
static=
templates=
flask_secret=
debug=True
log_level=0
mc=127.0.0.1
mc_debug=0
db=postgresql://pyhackers:@localhost/pyhackers

[sentry]
#dsn= http://sentry.local

[twitter]
client_id=
client_secret=

[github]
client_id=
client_secret=
```

and I've created a file called config.py which will initialize the <code>RawConfigParser</code> to read the configuration file.

```python
import logging
import ConfigParser
import os

config = ConfigParser.RawConfigParser()

configfiles = list()

# load default config file
dev_cfg = os.path.join(os.path.dirname(__file__), 'app.local.cfg')
logging.warn("Dev: %s" % dev_cfg)
configfiles += [dev_cfg]
# add more config files in your server to override the configuration of your development environment
configfiles += ['/var/`']

logging.warn('Configuration files read: %s' % configfiles)
# the MOST important line is here. Read the configuration.
files_read = config.read(configfiles)

logger.warn('Configuration files read: %s' % files_read)
```

Once this file is included, the config parser will run and will expose the <code>config</code> variable to the external files. Lets include it to our github
oauth file. Be careful with the name of your configuration file; mine is called **app.local.cfg**

## Initialize OAuth Service

```python
from rauth.service import OAuth2Service
from config import config
import requests

github = OAuth2Service(name='github',
                       authorize_url='https://github.com/login/oauth/authorize',
                       access_token_url="https://github.com/login/oauth/access_token",
                       client_id=config.get("github", 'client_id'),
                       client_secret=config.get("github", 'client_secret')
)
```

So, our github OAuth2Service is ready to take action. It's time to connect our Flask URL endpoints.

## Flask Routing

```python
@app.route('/oauth/github')
def login():
    """You can also specify the redirect URL, but I leave as it is."""
    # params = {'redirect_uri': redirect_uri}
    return redirect(github.get_authorize_url()) #**params))
```

Once the user requests the <code>/oauth/github</code> Flask will redirect the user to a specific URL that will be generated by the Oauth2Service.
This URL is going to be a special Github URL that will ask users if they are sure to give permissions to the application.

<img src='http://cdn.pythonarticles.com/static/img/github_auth.png' alt='github integration permission question />

After the user accepts the consequences, she will be redirected back to your application. Github will pass the code parameter.
Lets implement the redirection

## Github User Redirect

```python
@app.route('/oauth/github/authorized')
def authorized():
    # redirect_uri = url_for('authorized', _external=True)
    redirect_uri = urllib.quote("http://localhost:5001/oauth/github/authorized")

    data = dict(code=request.args['code'], redirect_uri=redirect_uri)

    r = requests.post('https://github.com/login/oauth/access_token', data={
        'client_id': config.get("github", 'client_id'),
        'client_secret': config.get("github", 'client_secret'),
        'code': request.args['code'],
    }, )

    response_data =  (url_decode(r.text))
    access_token = response_data['access_token']

    user_data = requests.get("https://api.github.com/user",params=dict(access_token=access_token))
    user_info = user_data.json()
    return jsonify(user_info)
```

I've found out that the normal RAuth documentation(which uses Facebook as the example) was not working correctly.

Let's dive into the details and explain what we did.

```python
data = dict(code=request.args['code'], redirect_uri=redirect_uri)
```

Use the code that Github gave us with the user redirect. Github [Oauth Web Flow Documentation section 2 says that](http://developer.github.com/v3/oauth/#web-application-flow) once the code is recieve the next step is to make a POST
request to github to fetch the <code>access_token</code> via a POST request using <code>client_id</code>, <code>code</code>, and <code>scope</code> if wanted.
Since I only want to get the public information, I did not specified any [scopes](http://developer.github.com/v3/oauth/#scopes).

```
POST https://github.com/login/oauth/access_token
```

## Github User Details

translated to the following python code

```python
r = requests.post('https://github.com/login/oauth/access_token', data={
        'client_id': config.get("github", 'client_id'),
        'client_secret': config.get("github", 'client_secret'),
        'code': request.args['code'],
    }, )
```

and let's get our access token

```python
response_data =  (url_decode(r.text))
access_token = response_data['access_token']
```

## Github User Data

Allright, we have a <code>access_token</code> now. It's time to query github API to learn who this user is;

```python
user_data = requests.get("https://api.github.com/user",params=dict(access_token=access_token))
user_info = user_data.json()
```


<code>user_info</code> is a Python dictionary contains the following information

```json
{
    "avatar_url": "https://secure.gravatar.com/avatar/1359f4b8cdd38927a92181bfe08ae90a?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png",
    "bio": null,
    "blog": "blog.bahadir.io",
    "company": null,
    "created_at": "2009-10-25T11:52:40Z",
    "email": "xxx@xxx.com",
    "events_url": "https://api.github.com/users/bcambel/events{/privacy}",
    "followers": 10,
    "followers_url": "https://api.github.com/users/bcambel/followers",
    "following": 24,
    "following_url": "https://api.github.com/users/bcambel/following{/other_user}",
    "gists_url": "https://api.github.com/users/bcambel/gists{/gist_id}",
    "gravatar_id": "1359f4b8cdd38927a92181bfe08ae90a",
    "hireable": true,
    "html_url": "https://github.com/bcambel",
    "id": 144385,
    "location": "Amsterdam, The Netherlands",
    "login": "bcambel",
    "name": "Bahadir Cambel",
    "organizations_url": "https://api.github.com/users/bcambel/orgs",
    "public_gists": 31,
    "public_repos": 62,
    "received_events_url": "https://api.github.com/users/bcambel/received_events",
    "repos_url": "https://api.github.com/users/bcambel/repos",
    "starred_url": "https://api.github.com/users/bcambel/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bcambel/subscriptions",
    "type": "User",
    "updated_at": "2013-08-01T16:42:31Z",
    "url": "https://api.github.com/users/bcambel"
}
```

To see the full source go to the [PythonHackers Github Repository](https://github.com/pythonhackers/pythonhackers/blob/github_integration/src/pyhackers/controllers/oauth/github.py)



